{% extends 'base.html' %}

{% block title %}Criar Novo Pedido - Reparo2Eletro{% endblock %}

{% block head %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
    <div class="header-container fade-in">
        <h2><i class="fas fa-plus-circle"></i> Criar Novo Pedido de Reparo</h2>
        <a href="{{ url_for('index') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
    </div>

    <div class="card fade-in">
        <form method="post" class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="numero_pedido"><i class="fas fa-hashtag"></i> Número do Pedido</label>
                    <input type="text" name="numero_pedido" id="numero_pedido" placeholder="Ex: PED-2023-001" required autofocus>
                </div>
                <div class="form-group">
                    <label for="tecnico_nome"><i class="fas fa-user-tie"></i> Nome do Técnico</label>
                    <select name="tecnico_nome" id="tecnico_nome" class="form-select" required>
                        <option value="" disabled selected>Selecione o técnico...</option>
                        {% for tecnico in tecnicos %}
                            <option value="{{ tecnico.nome }}">{{ tecnico.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <hr>

            <div class="pecas-section">
                <h4><i class="fas fa-tools"></i> Peças e Defeitos</h4>
                <div id="pecas-container">
                    <!-- As linhas de peças serão adicionadas aqui -->
                </div>
                <button type="button" id="add-peca-btn" class="btn btn-secondary"><i class="fas fa-plus"></i> Adicionar Peça</button>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Pedido e Peças</button>
            </div>
        </form>
    <!-- Template para uma nova linha de peça -->
    <template id="peca-template">
        <div class="peca-row">
            <div class="form-group">
                <label for="peca_nome"><i class="fas fa-cog"></i> Peça</label>
                <select name="peca_nome[]" class="form-select peca-select" required>
                    <option value="" disabled selected>Pesquise e selecione a peça...</option>
                    {% for tipo in tipos_pecas %}
                        <option value="{{ tipo.nome }}" data-id="{{ tipo.id }}">{{ tipo.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="peca_defeito"><i class="fas fa-exclamation-triangle"></i> Defeito</label>
                <select name="peca_defeito[]" class="form-select defeito-select" required>
                    <option value="" disabled selected>Selecione a peça primeiro</option>
                </select>
            </div>
            <button type="button" class="btn btn-danger remove-peca-btn"><i class="fas fa-trash-alt"></i></button>
        </div>
    </template>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Variáveis globais
        let pecasContainer;
        let addPecaBtn;
        let pecaTemplate;

        // Função para inicializar a página
        function initPage() {
            pecasContainer = document.getElementById('pecas-container');
            addPecaBtn = document.getElementById('add-peca-btn');
            pecaTemplate = document.getElementById('peca-template');

            // Inicializa o campo de técnico como um select simples
            $('#tecnico_nome').select2({
                theme: 'bootstrap-5',
                minimumResultsForSearch: -1,  // Desativa a barra de pesquisa
                placeholder: 'Selecione o técnico',
                allowClear: true,
                width: '100%'
            });

            // Adiciona a primeira linha de peça
            addPecaRow();

            // Configura o evento de clique do botão de adicionar peça
            if (addPecaBtn) {
                addPecaBtn.addEventListener('click', addPecaRow);
            }

            // Impede o envio do formulário ao pressionar Enter em um campo de seleção
            $(document).on('keydown', '.select2-search__field', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    return false;
                }
            });
            }

            // Função para obter as peças já selecionadas
            function getPecasSelecionadas(excludeSelect = null) {
                const pecas = [];
                document.querySelectorAll('.peca-select').forEach(select => {
                    if (select !== excludeSelect && select.value) {
                        pecas.push(select.value);
                    }
                });
                return pecas;
            }

            // Função para atualizar as opções disponíveis no select de peças
            function updatePecaOptions(selectElement) {
                const pecasSelecionadas = getPecasSelecionadas(selectElement);
                const currentValue = selectElement.value;
                
                // Habilita/desabilita as opções com base nas peças já selecionadas
                $(selectElement).find('option').each(function() {
                    const option = $(this);
                    const optionValue = option.val();
                    
                    if (optionValue === '' || optionValue === currentValue) {
                        option.prop('disabled', false);
                    } else {
                        option.prop('disabled', pecasSelecionadas.includes(optionValue));
                    }
                });
                
                // Atualiza o Select2 para refletir as mudanças
                if ($(selectElement).data('select2')) {
                    $(selectElement).trigger('change.select2');
                }
            }

            // Função para adicionar uma nova linha de peça
            function addPecaRow() {
                if (!pecaTemplate || !pecasContainer) return;

                const newRow = pecaTemplate.content.cloneNode(true);
                pecasContainer.appendChild(newRow);
                const rowElement = pecasContainer.lastElementChild;
                
                // Inicializa os selects da nova linha
                const pecaSelect = rowElement.querySelector('.peca-select');
                initPecaSelect(pecaSelect);
                initDefeitoSelect(rowElement.querySelector('.defeito-select'));
                
                // Atualiza as opções disponíveis
                updatePecaOptions(pecaSelect);
                
                // Adiciona o evento de mudança para atualizar as opções quando uma peça for selecionada
                $(pecaSelect).on('change', function() {
                    // Atualiza as opções em todos os selects de peça
                    document.querySelectorAll('.peca-select').forEach(select => {
                        updatePecaOptions(select);
                    });
                });
                
                // Adiciona o evento de clique no botão de remover peça
                var removeBtn = rowElement.querySelector('.remove-peca-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        // Remove a linha da peça
                        rowElement.remove();
                        
                        // Atualiza as opções de peças disponíveis
                        document.querySelectorAll('.peca-select').forEach(function(select) {
                            updatePecaOptions(select);
                        });
                    });
                }
            }
            
            // Função para inicializar o Select2 para um campo de peça (apenas seleção)
            function initPecaSelect(select) {
                $(select).select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Selecione a peça',
                    allowClear: true,
                    tags: false,
                    width: '100%',
                    templateResult: function (data) {
                        if (!data.id) {
                            return data.text;
                        }
                        const $result = $('<span>').text(data.text);
                        if (data.element && $(data.element).is(':disabled')) {
                            $result.addClass('text-muted');
                        }
                        return $result;
                    },
                    templateSelection: function(data) {
                        if (!data.id) return data.text;
                        return data.text;
                    },
                    escapeMarkup: function(m) { return m; }
                });
            }

            // Função para validar o formulário
            function validateForm(e) {
                var isValid = true;
                var pecaSelects = document.querySelectorAll('.peca-select');
                var defeitoSelects = document.querySelectorAll('.defeito-select');
                var pecasSelecionadas = new Set();
                var hasDuplicates = false;

                // Remove mensagens de erro anteriores
                var errorElements = document.querySelectorAll('.error-message, .alert-danger');
                for (var i = 0; i < errorElements.length; i++) {
                    errorElements[i].parentNode.removeChild(errorElements[i]);
                }

                // Verifica campos vazios e duplicatas
                for (var i = 0; i < pecaSelects.length; i++) {
                    var select = pecaSelects[i];
                    var index = i;
                    if (!select.value) {
                        isValid = false;
                        var errorMsg = document.createElement('div');
                        errorMsg.className = 'error-message text-danger mt-1';
                        errorMsg.textContent = 'Por favor, selecione uma peça';
                        select.parentNode.appendChild(errorMsg);
                    } else if (pecasSelecionadas.has(select.value)) {
                        hasDuplicates = true;
                        var errorMsg = document.createElement('div');
                        errorMsg.className = 'error-message text-danger mt-1';
                        errorMsg.textContent = 'Esta peça já foi adicionada ao pedido';
                        select.parentNode.appendChild(errorMsg);
                        isValid = false;
                    } else {
                        pecasSelecionadas.add(select.value);
                    }

                    // Valida o campo de defeito
                    if (!defeitoSelects[index] || !defeitoSelects[index].value) {
                        isValid = false;
                        var errorContainer = defeitoSelects[index] ?
                            defeitoSelects[index].parentNode : select.parentNode;
                        var errorMsg = document.createElement('div');
                        errorMsg.className = 'error-message text-danger mt-1';
                        errorMsg.textContent = 'Por favor, selecione um defeito';
                        errorContainer.appendChild(errorMsg);
                    }
                }

                // Exibe mensagem de erro para duplicatas
                if (hasDuplicates) {
                    var errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-danger mt-3';
                    errorMsg.textContent = 'Não é permitido adicionar a mesma peça mais de uma vez no mesmo pedido.';
                    
                    // Insere a mensagem antes do botão de adicionar peça
                    var addButton = document.getElementById('add-peca-btn');
                    if (addButton && addButton.parentNode) {
                        addButton.parentNode.insertBefore(errorMsg, addButton);
                    }
                }

                // Impede o envio do formulário se houver erros
                if (!isValid || hasDuplicates) {
                    e.preventDefault();
                    return false;
                }
                return true;
            }

            // Inicializa a página quando o DOM estiver pronto
            document.addEventListener('DOMContentLoaded', initPage);
{% endblock %}
