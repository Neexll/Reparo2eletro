{% extends 'base.html' %}

{% block title %}Novo Pedido - Reparo2Eletro{% endblock %}

{% block head %}
{{ super() }}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    /* Estilos para o Select2 */
    .select2-container {
        position: relative;
        z-index: 1 !important;
    }
    
    .select2-dropdown {
        border: 1px solid #ced4da !important;
        border-radius: 0.35rem !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        z-index: 9999 !important;
    }
    
    .select2-container--open .select2-dropdown--below {
        margin-top: 4px !important;
    }
    
    .select2-container--open .select2-dropdown--above {
        margin-bottom: 4px !important;
    }
    
    .select2-results__option {
        padding: 0.5rem 1rem;
    }
    
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #f8f9fa;
        color: #212529;
    }
    
    /* Estilos gerais */
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        padding: 1rem 1.35rem;
        border-radius: 10px 10px 0 0 !important;
    }
    
    .card-header h5 {
        font-weight: 600;
        color: #4e73df;
        margin: 0;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    /* Estilos para os campos do formulário */
    .form-label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select, .select2-container--default .select2-selection--single {
        border: 1px solid #d1d3e2;
        border-radius: 0.35rem;
        padding: 0.5rem 0.75rem;
        height: calc(2.25rem + 2px);
    }
    
    /* Estilos para a seção de peças */
    .peca-item {
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .peca-item:last-child {
        margin-bottom: 0;
    }
    
    .remove-peca {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        color: #e74a3b;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .add-peca-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    /* Estilos para os botões */
    .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
    }
    
    .btn-outline-primary {
        color: #4e73df;
        border-color: #4e73df;
    }
    
    .btn-outline-primary:hover {
        background-color: #4e73df;
        color: #fff;
    }
    
    /* Ajustes para o Select2 */
    .select2-container {
        width: 100% !important;
    }
    
    .select2-container--default .select2-selection--single {
        height: 38px !important;
        border: 1px solid #d1d3e2 !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
    }
    
    .select2-dropdown {
        border: 1px solid #d1d3e2 !important;
        border-radius: 0.35rem !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
    }
    
    /* Ajustes para responsividade */
    @media (max-width: 768px) {
        .card-body {
            padding: 1rem;
        }
        
        .peca-item {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Novo Pedido</h1>
    </div>
    
    <form id="formPedido" method="POST" action="{{ url_for('add_pedido') }}">
        <!-- Informações do Cliente -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Informações do Cliente</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="cliente" class="form-label">Nome do Cliente</label>
                        <input type="text" class="form-control" id="cliente" name="cliente" required>
                    </div>
                    <div class="col-md-6">
                        <label for="telefone" class="form-label">Telefone</label>
                        <input type="tel" class="form-control" id="telefone" name="telefone" required>
                    </div>
                    <div class="col-12">
                        <label for="endereco" class="form-label">Endereço</label>
                        <input type="text" class="form-control" id="endereco" name="endereco">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Itens do Pedido -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Itens do Pedido</h5>
                <button type="button" class="btn btn-sm btn-primary" id="adicionarPeca">
                    <i class="fas fa-plus"></i> Adicionar Peça
                </button>
            </div>
            <div class="card-body" id="listaPecas">
                <!-- Os itens serão adicionados aqui dinamicamente -->
            </div>
        </div>
        
        <!-- Observações -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Observações</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="observacoes" class="form-label">Observações Adicionais</label>
                    <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Botões de Ação -->
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            <div>
                <button type="button" class="btn btn-outline-danger me-2">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar Pedido
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Template para novos itens de peça -->
<template id="templatePeca">
    <div class="peca-item" data-index="__INDEX__">
        <span class="remove-peca"><i class="fas fa-times"></i></span>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Peça</label>
                <select name="peca_nome[]" class="form-select select-peca" required>
                    <option value="" selected disabled>Selecione uma peça...</option>
                    <!-- As opções serão preenchidas via JavaScript -->
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Defeito</label>
                <select name="peca_defeito[]" class="form-select select-defeito" required>
                    <option value="" selected disabled>Selecione o defeito...</option>
                    <!-- As opções serão preenchidas via JavaScript -->
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Valor (R$)</label>
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" step="0.01" min="0" class="form-control" name="peca_valor[]" required>
                </div>
            </div>
            <div class="col-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="peca_garantia[]" value="1" id="garantia__INDEX__">
                    <label class="form-check-label" for="garantia__INDEX__">
                        Em garantia
                    </label>
                </div>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializa os selects com Select2
    function initSelect2() {
        // Remove qualquer instância existente do Select2
        $('.select2-hidden-accessible').select2('destroy');
        $('.select2-dropdown').remove();
        
        // Inicializa cada select individualmente
        $('.select-peca, .select-defeito').each(function() {
            const $select = $(this);
            
            // Configuração básica do Select2
            $select.select2({
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $('body'),
                dropdownAutoWidth: true,
                containerCss: {
                    'position': 'relative',
                    'z-index': '1'
                },
                dropdownCss: {
                    'position': 'absolute',
                    'z-index': '9999 !important',
                    'width': '100%',
                    'left': '0 !important',
                    'top': '100% !important',
                    'margin-top': '4px !important',
                    'transform': 'none !important',
                    'will-change': 'transform !important'
                }
            });
            
            // Manipulação personalizada do dropdown
            $select.on('select2:open', function(e) {
                // Remove qualquer dropdown antigo
                $('.select2-dropdown').not('.select2-dropdown--below').remove();
                
                // Obtém os elementos necessários
                const $select2 = $(e.target);
                const $select2Container = $select2.data('select2').$container;
                const $dropdown = $('.select2-dropdown');
                
                // Se não encontrou o dropdown, tenta novamente após um pequeno atraso
                if ($dropdown.length === 0) {
                    setTimeout(() => {
                        $('.select2-dropdown').css({
                            'position': 'absolute',
                            'width': $select2.outerWidth() + 'px',
                            'left': $select2.offset().left + 'px',
                            'top': ($select2.offset().top + $select2.outerHeight()) + 'px',
                            'z-index': '9999',
                            'display': 'block'
                        });
                    }, 10);
                    return;
                }
                
                // Calcula a posição correta
                const selectRect = $select2[0].getBoundingClientRect();
                const scrollY = window.scrollY || document.documentElement.scrollTop;
                
                // Posiciona o dropdown
                $dropdown.css({
                    'position': 'absolute',
                    'width': selectRect.width + 'px',
                    'left': selectRect.left + 'px',
                    'top': (selectRect.bottom + scrollY) + 'px',
                    'z-index': '9999',
                    'display': 'block',
                    'opacity': '1',
                    'margin': '0',
                    'transform': 'none',
                    'will-change': 'transform'
                });
                
                // Adiciona um ouvinte de rolagem para reposicionar o dropdown
                const scrollHandler = function() {
                    const newTop = ($select2.offset().top + $select2.outerHeight());
                    $dropdown.css('top', newTop + 'px');
                };
                
                // Remove ouvintes de rolagem antigos e adiciona um novo
                $(window).off('scroll.select2-dropdown');
                $(window).on('scroll.select2-dropdown', scrollHandler);
                
                // Remove o ouvinte quando o dropdown for fechado
                $select.one('select2:closing', function() {
                    $(window).off('scroll.select2-dropdown');
                });
            });
            
            // Limpeza quando o select for destruído
            $select.on('select2:closing', function() {
                $(window).off('scroll.select2-dropdown');
            });
        });
    }
    
    // Carrega as peças disponíveis
    function carregarPecas($select) {
        fetch('/api/pecas')
            .then(response => response.json())
            .then(pecas => {
                $select.empty().append('<option value="" selected disabled>Selecione uma peça...</option>');
                pecas.forEach(peca => {
                    $select.append(new Option(peca.nome, peca.id, false, false));
                });
            })
            .catch(error => console.error('Erro ao carregar peças:', error));
    }
    
    // Carrega os defeitos de uma peça
    function carregarDefeitos(pecaId, $select) {
        if (!pecaId) return;
        
        fetch(`/api/pecas/${pecaId}/defeitos`)
            .then(response => response.json())
            .then(defeitos => {
                $select.empty().append('<option value="" selected disabled>Selecione o defeito...</option>');
                if (defeitos && defeitos.length > 0) {
                    defeitos.forEach(defeito => {
                        $select.append(new Option(defeito, defeito, false, false));
                    });
                } else {
                    $select.append(new Option('Nenhum defeito cadastrado', '', true, true));
                }
                $select.trigger('change');
            })
            .catch(error => console.error('Erro ao carregar defeitos:', error));
    }
    
    // Adiciona um novo item de peça
    function adicionarPeca() {
        const $template = $('#templatePeca');
        const $listaPecas = $('#listaPecas');
        const index = $listaPecas.children().length;
        
        const html = $template.html().replace(/__INDEX__/g, index);
        const $novaPeca = $(`<div class="mb-3">${html}</div>`);
        
        $listaPecas.append($novaPeca);
        
        // Inicializa os selects
        initSelect2();
        
        // Carrega as peças disponíveis
        const $selectPeca = $novaPeca.find('.select-peca');
        carregarPecas($selectPeca);
        
        // Atualiza os defeitos quando uma peça é selecionada
        $selectPeca.on('change', function() {
            const pecaId = $(this).val();
            const $selectDefeito = $(this).closest('.peca-item').find('.select-defeito');
            carregarDefeitos(pecaId, $selectDefeito);
        });
        
        // Remove o item de peça
        $novaPeca.find('.remove-peca').on('click', function() {
            if ($listaPecas.children().length > 1) {
                $(this).closest('.mb-3').remove();
            } else {
                alert('É necessário ter pelo menos um item no pedido.');
            }
        });
    }
    
    // Adiciona a primeira peça ao carregar a página
    adicionarPeca();
    
    // Adiciona uma nova peça ao clicar no botão
    $('#adicionarPeca').on('click', adicionarPeca);
    
    // Máscara para o telefone
    $('#telefone').mask('(00) 00000-0000');
    
    // Validação do formulário
    $('#formPedido').on('submit', function(e) {
        let isValid = true;
        
        // Valida os campos obrigatórios
        $(this).find('[required]').each(function() {
            if (!$(this).val()) {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Por favor, preencha todos os campos obrigatórios.');
        }
    });
});
</script>
{% endblock %}
